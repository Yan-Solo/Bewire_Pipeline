version: '2.2'
services:
  gitlab:
    image: 'gitlab/gitlab-ce:11.5.2-ce.0'
    restart: always
    hostname: gitlab
    environment:
      - GITLAB_OMNIBUS_CONFIG=external_url 'http://192.168.1.14'
      - force=yes
    ports:
      - '80:80'
      - '222:22'
    volumes:
      - 'gitlab_config:/etc/gitlab'
      - 'gitlab_log:/etc/log/gitlab'
      - 'gitlab_data:/var/opt/gitlab'
      - 'gitlab_data_backups:/var/opt/gitlab/backups'

  jenkins:
    build: .
    restart: always
    hostname: jenkins
    environment:
      - /opt/sonar-runner/bin:$PATH
    ports:
      - '8080:8080'

  sonarqube:
    image: sonarqube
    hostname: sonarqube
    environment:
      - sonar.jdbc.url=jdbc:postgresql://db:5432/sonar
    ports:
      - '9000:9000'
    networks:
      - sonarnet
    volumes:
      - 'sonarqube_conf:/opt/sonarqube/conf'
      - 'sonarqube_data:/opt/sonarqube/data'
      - 'sonarqube_extensions:/opt/sonarqube/extensions'

  db:
    image: postgres
    networks:
      - sonarnet
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
    volumes:
      - 'postgresql:/var/lib/postgresql'
      - 'postgresql_data:/var/lib/postgresql/data'

  nexus:
    image: sonatype/nexus
    ports:
      - '8081:8081'
    volumes:
      - 'nexus_data:/sonatype-work'

networks:
  sonarnet:
    driver: bridge

volumes:
  gitlab_config:
  gitlab_log:
  gitlab_data:
  gitlab_data_backups:
  jenkins_data:
  sonarqube_conf:
  sonarqube_data:
  sonarqube_extensions:
  postgresql:
  postgresql_data:
  nexus_data:
